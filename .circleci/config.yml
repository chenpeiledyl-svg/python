# .circleci/config.yml
version: 2.1

# å¦‚éœ€ä¸¥æ ¼é˜²å¹¶å‘ï¼Œå¯è€ƒè™‘ queue orbï¼ˆéœ€ä¸ªäºº API Tokenï¼‰ã€‚
# orbs:
#   queue: eddiewebb/queue@x.y.z   # å¯é€‰ï¼šç”¨äºä¸²è¡ŒåŒ–æµæ°´çº¿

jobs:
  monitor:
    docker:
      - image: cimg/python:3.9    # é¢„è£… Python 3.9 ä¸ pip
    working_directory: ~/project
    environment:
      # å»ºè®®åœ¨ CircleCI é¡¹ç›®è®¾ç½®é‡Œæ·»åŠ ç¯å¢ƒå˜é‡ GH_TOKENï¼ˆGitHub PATï¼Œå…· repo æƒé™ï¼‰
      PIP_CACHE_DIR: ~/.cache/pip
    steps:
      - checkout

      # ï¼ˆå¯é€‰ï¼‰è§£é™¤æµ…å…‹éš†ï¼Œä¾¿äºåç»­æ¨é€
      - run:
          name: Unshallow fetch (optional)
          command: |
            git fetch --prune --unshallow || true

      # å¦‚ä½¿ç”¨ queue orbï¼Œå¯ä»¥åœ¨æ­¤é˜»å¡ç›´åˆ°å‰åºåŒç»„æ„å»ºå®Œæˆ
      # - queue/until_front_of_line:
      #     consider-branch: true
      #     time: "30"   # æœ€å¤šç­‰å¾… 30 åˆ†é’Ÿ

      # ä¿é™©ï¼šå³ä½¿æ‰‹åŠ¨è§¦å‘ï¼Œä¹Ÿåªåœ¨åŒ—äº¬æ—¶é—´çª—å£å†…ç»§ç»­æ‰§è¡Œ
      - run:
          name: Check Beijing-time window (07:30â€“22:00)
          command: |
            now=$(TZ=Asia/Shanghai date +%H:%M)
            echo "Now(CST)=$now"
            if [[ "$now" < "07:30" || "$now" > "22:00" ]]; then
              echo "â­ï¸  Not in window, skipping."
              circleci-agent step halt
            fi

      # æ¢å¤ pip ç¼“å­˜
      - restore_cache:
          keys:
            - v1-pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
            - v1-pip-{{ arch }}-{{ .Branch }}
            - v1-pip-

      # ï¼ˆå¦‚ sq.py ä¸éœ€è¦æµè§ˆå™¨ï¼Œå¯åˆ æ‰ä¸‹é¢ä¸¤å—æ³¨é‡Šï¼‰
      # - run:
      #     name: Install system dependencies
      #     command: |
      #       sudo apt-get update
      #       sudo apt-get install -y wget gnupg unzip

      # - run:
      #     name: Install Chrome
      #     command: |
      #       wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-linux.gpg
      #       echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-linux.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
      #       sudo apt-get update
      #       sudo apt-get install -y google-chrome-stable

      - run:
          name: Install Python dependencies
          command: |
            python -m pip install --upgrade pip
            if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # ä¿å­˜ pip ç¼“å­˜
      - save_cache:
          paths:
            - ~/.cache/pip
          key: v1-pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}

      - run:
          name: Run seat monitor
          no_output_timeout: 15m
          command: |
            echo "å¼€å§‹è¿è¡Œåº§ä½ç›‘æ§ - $(TZ=Asia/Shanghai date)"
            python sq.py $(date +%Y-%m-%d)
            echo "ç›‘æ§å®Œæˆ - $(TZ=Asia/Shanghai date)"

      - run:
          name: Show log if exists
          command: |
            if [ -f "seat_monitor.log" ]; then
              echo "=== æœ€æ–°æ—¥å¿— ==="
              tail -20 seat_monitor.log
            fi

      - run:
          name: Commit and push changes (skip empty)
          command: |
            git config --global safe.directory "$PWD"
            git config --global user.email "circleci-bot@example.com"
            git config --global user.name "CircleCI Bot"

            # ä»…æ·»åŠ å¯èƒ½æ›´æ–°çš„æ–‡ä»¶ï¼Œé¿å…æŠŠæ— å…³æ–°æ–‡ä»¶æ„å¤–æäº¤
            git add -A *.csv *.log 2>/dev/null || true

            # ç©ºå˜æ›´åˆ™è·³è¿‡
            if git diff --staged --quiet; then
              echo "æ²¡æœ‰æ–°çš„æ•°æ®å˜æ›´ï¼Œè·³è¿‡æäº¤"
              exit 0
            fi

            git commit -m "ğŸ“Š åº§ä½æ•°æ®æ›´æ–° $(date -u '+%Y-%m-%d %H:%M UTC')"

            # ä½¿ç”¨ GH_TOKEN æ¨å›å½“å‰åˆ†æ”¯ï¼›è¯·åœ¨ CircleCI é¡¹ç›®/Context é‡Œé…ç½® GH_TOKEN
            if [ -z "$GH_TOKEN" ]; then
              echo "GH_TOKEN æœªè®¾ç½®ï¼Œæ— æ³•æ¨é€ã€‚"
              exit 1
            fi
            remote_url=$(git config --get remote.origin.url)
            remote_url=${remote_url/https:\/\//https:\/\/${GH_TOKEN}@}
            git push "$remote_url" "HEAD:${CIRCLE_BRANCH}"

workflows:
  version: 2
  seat-monitor:
    triggers:
      - schedule:
          # GitHub Actions çš„ UTC è®¡åˆ’è½¬ä¸º CircleCIï¼š00:00â€“14:59 æ¯ 5 åˆ†é’Ÿ
          cron: "*/5 0-14 * * *"
          filters:
            branches:
              only:
                - main    # â‡ æ ¹æ®ä½ çš„é»˜è®¤åˆ†æ”¯è°ƒæ•´
      - schedule:
          # 23:30, 23:35, â€¦, 23:55 UTC
          cron: "30-59/5 23 * * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - monitor
